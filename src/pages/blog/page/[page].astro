---
import StarlightPage from "@astrojs/starlight/components/StarlightPage.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = (
    await getCollection(
      "docs",
      ({ id, data }) => id.startsWith("blog/") && !(data as any)?.draft,
    )
  )
    .filter((p) => (p.data as any)?.date || (p.data as any)?.updatedAt)
    .sort((a, b) => {
      const ad = new Date(
        ((a.data as any)?.date ?? (a.data as any)?.updatedAt) as string,
      ).getTime();
      const bd = new Date(
        ((b.data as any)?.date ?? (b.data as any)?.updatedAt) as string,
      ).getTime();
      return bd - ad;
    });
  const POSTS_PER_PAGE = 12;
  const totalPages = Math.max(1, Math.ceil(posts.length / POSTS_PER_PAGE));
  return Array.from({ length: totalPages }).map((_, i) => ({
    params: { page: String(i + 1) },
  }));
}

const base = import.meta.env.BASE_URL || "/";
const { page } = Astro.params;
const currentPage = Math.max(1, Number(page));
const POSTS_PER_PAGE = 12;

const all = (
  await getCollection(
    "docs",
    ({ id, data }) => id.startsWith("blog/") && !(data as any)?.draft,
  )
)
  .filter((p) => (p.data as any)?.date || (p.data as any)?.updatedAt)
  .sort((a, b) => {
    const ad = new Date(
      ((a.data as any)?.date ?? (a.data as any)?.updatedAt) as string,
    ).getTime();
    const bd = new Date(
      ((b.data as any)?.date ?? (b.data as any)?.updatedAt) as string,
    ).getTime();
    return bd - ad;
  });

const totalPages = Math.max(1, Math.ceil(all.length / POSTS_PER_PAGE));
const start = (currentPage - 1) * POSTS_PER_PAGE;
const end = start + POSTS_PER_PAGE;
const posts = all.slice(start, end);

const pageHref = (n: number) =>
  n === 1 ? `${base}blog/` : `${base}blog/page/${n}/`;

const frontmatter = {
  title: `블로그 · 페이지 ${currentPage}`,
  description: "블로그 글 페이지네이션 목록",
  editUrl:
    "https://github.com/Lonpeach/astro/edit/main/src/pages/blog/page/[page].astro",
  tableOfContents: false,
  preferBodyH1: true,
};
---

<StarlightPage frontmatter={frontmatter} hasSidebar={false}>
  <header class="blog-header">
    <a href={`${base}blog/`} class="back-btn">
      <span class="icon">←</span>
      <span>블로그 메인 (페이지 {currentPage})</span>
    </a>
  </header>

  {
    posts.length === 0 ? (
      <p>게시된 글이 없습니다.</p>
    ) : (
      <>
        <div class="post-grid">
          {posts.map((post) => {
            const data: any = post.data as any;
            const href = `${base}${(post as any).slug ?? (post as any).id}/`;
            const title = data?.title ?? (post as any).slug ?? post.id;
            const d = new Date(
              ((data?.date ?? data?.updatedAt) as string) ?? "",
            );
            const dateIso = isNaN(d.getTime())
              ? ""
              : d.toISOString().slice(0, 10);
            let dateKST = dateIso;
            try {
              dateKST = d.toLocaleDateString("ko-KR", {
                timeZone: "Asia/Seoul",
              });
            } catch {}
            const desc = data?.description as string | undefined;
            const section = (post as any).id.split("/")[0];
            const sectionLabel = section.toUpperCase();

            return (
              <a href={href} class="glass-card-post">
                <div class="card-glow-bg" />
                <div class="inner">
                  <div class="meta">
                    <span class="meta-tag">{sectionLabel}</span>
                    {dateIso && (
                      <time datetime={dateIso} class="meta-date">
                        {dateKST}
                      </time>
                    )}
                  </div>
                  <h3 class="post-title">{title}</h3>
                  {desc && <p class="post-desc">{desc}</p>}
                  <div class="action">
                    <span>더 보기</span>
                    <span class="icon">→</span>
                  </div>
                </div>
              </a>
            );
          })}
        </div>

        {totalPages > 1 && (
          <nav class="pager" aria-label="페이지 네비게이션">
            <a
              class={`pager-link prev ${currentPage === 1 ? "disabled" : ""}`}
              href={currentPage === 1 ? undefined : pageHref(currentPage - 1)}
              aria-disabled={currentPage === 1}
            >
              « 이전
            </a>
            {Array.from({ length: totalPages }).map((_, i) => {
              const n = i + 1;
              const current = n === currentPage;
              return (
                <a
                  class={`pager-link ${current ? "current" : ""}`}
                  href={pageHref(n)}
                  aria-current={current ? "page" : undefined}
                >
                  {n}
                </a>
              );
            })}
            <a
              class={`pager-link next ${currentPage === totalPages ? "disabled" : ""}`}
              href={
                currentPage === totalPages
                  ? undefined
                  : pageHref(currentPage + 1)
              }
              aria-disabled={currentPage === totalPages}
            >
              다음 »
            </a>
          </nav>
        )}
      </>
    )
  }
</StarlightPage>

<style>
  .blog-header {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-bottom: 3rem;
  }
  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: var(--sl-color-accent);
    background: color-mix(in srgb, var(--sl-color-accent), transparent 95%);
    border: 1px solid
      color-mix(in srgb, var(--sl-color-accent), transparent 80%);
    padding: 0.4rem 0.8rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s;
    margin-bottom: 1.5rem;
  }
  .back-btn:hover {
    background: color-mix(in srgb, var(--sl-color-accent), transparent 85%);
    border-color: var(--sl-color-accent);
    transform: translateX(-2px);
  }
  .blog-header .page-title {
    margin: 0 !important;
  }
  .page-num {
    font-size: 1.5rem;
    color: var(--sl-color-gray-4);
    font-weight: 500;
    margin-left: 0.5rem;
  }
  .page-description {
    color: var(--sl-color-gray-3);
    font-size: 1.1rem;
    margin-top: 0.5rem;
  }
  .post-grid {
    margin-top: 2rem;
  }
  .pager {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    align-items: center;
    margin-top: 3rem;
    flex-wrap: wrap;
  }
  .pager-link {
    display: inline-block;
    padding: 0.5rem 1rem;
    border: 1px solid var(--sl-color-gray-6);
    border-radius: 0.75rem;
    text-decoration: none;
    color: var(--sl-color-text);
    background: color-mix(in srgb, var(--sl-color-bg-nav), transparent 80%);
    transition: all 0.2s;
  }
  .pager-link:hover,
  .pager-link:focus {
    border-color: var(--sl-color-accent);
    background: color-mix(in srgb, var(--sl-color-bg-nav), transparent 60%);
  }
  .pager-link.current {
    border-color: var(--sl-color-accent);
    background: var(--sl-color-accent-low);
    color: var(--sl-color-accent-high);
    font-weight: 700;
  }
  .pager-link.disabled {
    opacity: 0.5;
    pointer-events: none;
  }
</style>
