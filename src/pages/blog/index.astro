---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import RecentPosts from "../../components/RecentPosts.astro";
import { getCollection } from 'astro:content';

const base = import.meta.env.BASE_URL || '/';

// All blog posts (for a simple index list)
const posts = (await getCollection('docs', ({ id, data }) => id.startsWith('blog/') && !(data as any)?.draft))
  .filter((p) => (p.data as any)?.date || (p.data as any)?.createdAt)
  .sort((a, b) => {
    const ad = new Date(((a.data as any)?.date ?? (a.data as any)?.createdAt) as string).getTime();
    const bd = new Date(((b.data as any)?.date ?? (b.data as any)?.createdAt) as string).getTime();
    return bd - ad;
  });
const hrefFor = (entry: any) => `${base}${(entry as any).slug ?? (entry as any).id}/`;

const frontmatter = {
  title: '블로그',
  description: '최근 글 목록과 아카이브·태그 탐색',
  editUrl: 'https://github.com/Lonpeach/astro/edit/main/src/pages/blog/index.astro',
};
---
<StarlightPage frontmatter={frontmatter} hasSidebar={false}>
  <RecentPosts />

  <nav class="chips-nav" aria-label="탐색">
    <a class="chip" href={`${base}blog/archive/`}>아카이브</a>
    <a class="chip" href={`${base}tags/`}>태그</a>
  </nav>

  <section aria-labelledby="all-posts">
    <h2 id="all-posts">전체 글</h2>
    {posts.length === 0 ? (
      <p>게시된 글이 없습니다.</p>
    ) : (
      <ul>
        {posts.map((post) => (
          <li>
            <a href={hrefFor(post)}>{post.data.title ?? (post as any).slug ?? post.id}</a>
            {((post.data as any)?.date || (post.data as any)?.createdAt) && (
              <small style="margin-left: 0.5rem; opacity: 0.7;">
                {new Date(((post.data as any)?.date ?? (post.data as any)?.createdAt) as string).toLocaleDateString()}
              </small>
            )}
          </li>
        ))}
      </ul>
    )}
  </section>
</StarlightPage>

<style>
  .chips-nav { display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 0.5rem 0 1rem; }
  .chip { display: inline-block; padding: 0.4rem 0.8rem; border-radius: 999px; border: 1px solid var(--sl-color-gray-6); background: color-mix(in hsl, var(--sl-color-gray-7) 40%, transparent); color: var(--sl-color-text); text-decoration: none; font-weight: 700; }
  .chip:hover, .chip:focus { border-color: var(--sl-color-gray-5); }
</style>

