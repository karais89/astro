---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const entries = (await getCollection('docs', ({ id, data }) => {
    const inSections = id.startsWith('til/') || id.startsWith('coding-test/') || id.startsWith('blog/');
    return inSections && (data as any)?.draft !== true;
  }))
    .filter((e) => (e.data as any)?.date || (e.data as any)?.createdAt);
  const years = Array.from(
    new Set(
      entries.map((e) => new Date(((e.data as any)?.date ?? (e.data as any)?.createdAt) as string).getFullYear())
    )
  ).sort((a, b) => b - a);
  return years.map((y) => ({ params: { year: String(y) } }));
}

const base = import.meta.env.BASE_URL || '/';
const { year } = Astro.params;
const targetYear = Number(year);
if (!Number.isFinite(targetYear)) throw new Error('잘못된 연도입니다');

const entries = (await getCollection('docs', ({ id, data }) => {
  const inSections = id.startsWith('til/') || id.startsWith('coding-test/') || id.startsWith('blog/');
  return inSections && (data as any)?.draft !== true;
}))
  .filter((e) => (e.data as any)?.date || (e.data as any)?.createdAt)
  .filter((e) => new Date(((e.data as any)?.date ?? (e.data as any)?.createdAt) as string).getFullYear() === targetYear)
  .sort((a, b) => {
    const ad = new Date(((a.data as any)?.date ?? (a.data as any)?.createdAt) as string).getTime();
    const bd = new Date(((b.data as any)?.date ?? (b.data as any)?.createdAt) as string).getTime();
    return bd - ad;
  });

const hrefFor = (entry: any) => `${base}${(entry as any).slug ?? (entry as any).id}/`;
const frontmatter = {
  title: `${targetYear} · 전체 아카이브`,
  description: `${targetYear}년 작성 글 모음 (TIL, 코딩테스트, 블로그)`,
  editUrl: 'https://github.com/Lonpeach/astro/edit/main/src/pages/archive/[year].astro',
};
---
<StarlightPage frontmatter={frontmatter} hasSidebar={false}>
  <p><a href={`${base}archive/`}>← 아카이브</a></p>

  {entries.length === 0 ? (
    <p>해당 연도의 글이 없습니다.</p>
  ) : (
    <ul>
      {entries.map((post) => (
        <li>
          <a href={hrefFor(post)}>{(post as any).data?.title ?? (post as any).slug ?? post.id}</a>
          {((post.data as any)?.date || (post.data as any)?.createdAt) && (
            <small style="margin-left: 0.5rem; opacity: 0.7;">
              {new Date(((post.data as any)?.date ?? (post.data as any)?.createdAt) as string).toLocaleDateString()}
            </small>
          )}
        </li>
      ))}
    </ul>
  )}
</StarlightPage>

