---
import { getCollection } from "astro:content";

interface Props {
  count?: number;
  sections?: string[]; // e.g., ['til'] or ['til', 'blog']
  variant?: "cards" | "list";
}

const { count = 5, sections, variant = "cards" } = Astro.props as Props;

const entries = await getCollection("docs", ({ id, data }) => {
  const allowed =
    Array.isArray(sections) && sections.length > 0
      ? sections.some((s) => id.startsWith(`${s}/`))
      : id.startsWith("til/") ||
        id.startsWith("coding-test/") ||
        id.startsWith("blog/");
  return allowed && data?.draft !== true;
});

const getDate = (e: any) =>
  new Date((e.data?.date ?? e.data?.updatedAt ?? 0) as string | number);
const recent = entries
  .filter((e) => e.id !== "index" && !e.id.endsWith("/index"))
  .sort((a, b) => Number(getDate(b)) - Number(getDate(a)))
  .slice(0, count);
---

{
  recent.length === 0 ? (
    <p>게시된 글이 없습니다.</p>
  ) : variant === "list" ? (
    <ul class="list">
      {recent.map((e) => {
        const base = import.meta.env.BASE_URL || "/";
        let path = e.id as string;
        if (path.endsWith("/index")) path = path.slice(0, -"/index".length);
        const href = `${base}${path}/`;
        const d = getDate(e);
        const dateIso = isNaN(d.getTime()) ? "" : d.toISOString().slice(0, 10);
        let dateKST = dateIso;
        try {
          dateKST = d.toLocaleDateString("ko-KR", { timeZone: "Asia/Seoul" });
        } catch {}
        const desc = e.data?.description as string | undefined;
        const tags = (e.data?.tags as string[] | undefined) ?? [];
        return (
          <li class="list-item">
            <div class="list-main">
              <a href={href} class="list-link">
                {e.data.title ?? path}
              </a>
              {desc && <p class="list-desc">{desc}</p>}
              {tags.length > 0 && (
                <div class="list-tags">
                  {tags.slice(0, 4).map((t) => (
                    <a
                      class="tag"
                      href={`${base}tags/${encodeURIComponent(t)}/`}
                    >
                      {t}
                    </a>
                  ))}
                </div>
              )}
            </div>
            {dateIso && (
              <time datetime={dateIso} class="list-date">
                {dateKST}
              </time>
            )}
          </li>
        );
      })}
    </ul>
  ) : (
    <div class="post-grid">
      {recent.map((e) => {
        const base = import.meta.env.BASE_URL || "/";
        let path = e.id as string;
        if (path.endsWith("/index")) path = path.slice(0, -"/index".length);
        const href = `${base}${path}/`;
        const d = getDate(e);
        const dateIso = isNaN(d.getTime()) ? "" : d.toISOString().slice(0, 10);
        let dateKST = dateIso;
        try {
          dateKST = d.toLocaleDateString("ko-KR", { timeZone: "Asia/Seoul" });
        } catch {}
        const desc = e.data?.description as string | undefined;
        const section = e.id.split("/")[0];
        const sectionLabel = section.toUpperCase();

        return (
          <a href={href} class="glass-card-post">
            <div class="card-glow-bg" />
            <div class="inner">
              <div class="meta">
                <span class="meta-tag">{sectionLabel}</span>
                {dateIso && (
                  <time datetime={dateIso} class="meta-date">
                    {dateKST}
                  </time>
                )}
              </div>
              <h3 class="post-title">{e.data.title ?? path}</h3>
              {desc && <p class="post-desc">{desc}</p>}
              <div class="action">
                <span>더 보기</span>
                <span class="icon">→</span>
              </div>
            </div>
          </a>
        );
      })}
    </div>
  )
}

<style>
  /* List variant integration */
  .list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.5rem;
  }
  .list-item {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.5rem 1rem;
    padding: 1rem;
    border: 1px solid var(--sl-color-gray-6);
    border-radius: 0.75rem;
    background: color-mix(in srgb, var(--sl-color-bg-nav), transparent 80%);
    transition: all 0.2s;
  }
  .list-item:hover {
    border-color: var(--sl-color-accent);
    background: color-mix(in srgb, var(--sl-color-bg-nav), transparent 60%);
  }
  .list-main {
    min-width: 0;
  }
  .list-link {
    color: var(--sl-color-text);
    text-decoration: none;
    font-weight: 700;
    font-size: 1.1rem;
  }
  .list-desc {
    margin: 0.25rem 0 0.5rem;
    color: var(--sl-color-gray-2);
    font-size: 0.95rem;
  }
  .list-tags {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
  }
  .tag {
    border: 1px solid var(--sl-color-gray-6);
    border-radius: 999px;
    padding: 0.125rem 0.5rem;
    font-size: 0.75rem;
    color: var(--sl-color-text);
    background: var(--sl-color-bg-step-1);
    text-decoration: none;
  }
  .list-date {
    color: var(--sl-color-gray-3);
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
    align-self: start;
    font-size: 0.9rem;
  }
</style>
